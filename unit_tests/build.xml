<?xml version="1.0"?>
<project name="web2project" basedir="." default="warning">
	<target name="warning">
		<echo message="Running Unit Tests is a destructive process and will drop/restore your database multiple times." />
		<echo message="Please only run Unit Tests against your development or test databases." />
		
		<echo message="To run tests, use the command: phing run-tests" />
	</target>

    <target name="run-tests">
        <phpunit codecoverage="true" haltonfailure="false" haltonerror="true">
            <formatter type="plain" usefile="false"/>
            <batchtest>
                <fileset dir="modules">
                    <include name="**/*.test.php"/>
                </fileset>

                <fileset dir="classes">
					<!--
						The UpgradeManager_Test (manager.test.php) should be 
						executed separately and before any/all of the other 
						tests because it can build up a database for us.  Any 
						ideas on how to do this successfully would be greatly 
						appreciated.  - caseydk 02 July 2009
					-->
                    <include name="**/*.test.php"/>
                </fileset>

                <fileset dir="includes">
                    <include name="**/*.test.php"/>
                </fileset>
            </batchtest>
            <formatter  type="xml" todir="reports" outfile="logfile.xml"/>
        </phpunit>
        <phpunitreport  infile="reports/logfile.xml"
            styledir="/usr/share/php/data/phing/etc/"
            todir="reports"
            format="noframes" />
    </target>

	<target name="standards" depends="lint">
		<!-- This is setup to run as separate tasks due to memory/performance reasons. -->

		<phpcodesniffer standard="PEAR" format="summary"
			file="../index.php" allowedFileExtensions="php" />
		<phpcodesniffer standard="PEAR" format="summary"
			file="../classes" allowedFileExtensions="php" />
		<phpcodesniffer standard="PEAR" format="summary"
			file="../includes" allowedFileExtensions="php" />
		<phpcodesniffer standard="PEAR" format="summary"
			file="../install" allowedFileExtensions="php" />
		<phpcodesniffer standard="PEAR" format="summary"
			file="../modules" allowedFileExtensions="php" />
		<phpcodesniffer standard="PEAR" format="summary"
			file="." allowedFileExtensions="php" />
	</target>

	<target name="package">
		<!-- 
			TODO: Right now this only pulls from trunk, eventually, it should 
			take user input and package from trunk, branch, or a specific tag.
		-->
		<svnexport
		   svnpath="/usr/bin/svn"
		   repositoryurl="https://web2project.svn.sourceforge.net/svnroot/web2project/trunk/"
		   todir="web2project"/>
		<delete dir="web2project/unit_tests/" />

		<!--
			TODO: This is duplicated from the lint target below and should be 
			refactored to call that target with parameters.
		-->
		<phplint haltonfailure="true">
			<fileset dir="web2project">
				<include name="**/*.php" />
				<exclude name="lib/" />
			</fileset>
		</phplint>

		<tar destfile="web2project.tar.gz" compression="gzip">
			<fileset dir="web2project/">
				<include name="**/**" />
				<exclude name="unit_tests/" />
			</fileset>
		</tar>
		<zip destfile="web2project.zip">
			<fileset dir="web2project/">
				<include name="**/**" />
				<exclude name="unit_tests/" />
			</fileset>
		</zip>
		<delete dir="web2project/" />
	</target>

	<target name="lint">
		<phplint haltonfailure="true">
			<fileset dir="..">
				<include name="**/*.php" />
				<exclude name="lib/" />
			</fileset>
		</phplint>
  	</target>
</project>